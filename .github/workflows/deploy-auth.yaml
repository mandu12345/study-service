ame: Deploy Auth Service

on:
  push:
    branches: [ "main" ]
    paths:
      - 'auth-service/**'       # Auth ì½”ë“œê°€ ë³€í•˜ê±°ë‚˜
      - 'common-**/**'          # Common ëª¨ë“ˆì´ ë³€í•˜ê±°ë‚˜
      - 'pom.xml'               # ë£¨íŠ¸ ì„¤ì •ì´ ë³€í•˜ë©´ ì‹¤í–‰
      - '.github/workflows/deploy-auth.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # 2. JDK 17 ì„¸íŒ… (Maven ë¹Œë“œìš©)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3. Maven ë¹Œë“œ (í•µì‹¬ âœ¨)
      # -pl auth-service : auth-serviceë§Œ ë¹Œë“œí•´ë¼
      # -am : ê·¼ë° ê±”ê°€ ì˜ì¡´í•˜ëŠ” ì• ë“¤(common)ë„ ê°™ì´ ë¹Œë“œí•´ë¼
      - name: Build with Maven
        run: mvn clean package -pl auth-service -am -DskipTests

      # 4. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. ë„ì»¤ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          # [ìˆ˜ì •] ê³µìš© Dockerfileì„ ì“°ë ¤ë©´ ì»¨í…ìŠ¤íŠ¸ëŠ” ë£¨íŠ¸(.)ì—¬ì•¼ í•¨
          context: .
          # [ìˆ˜ì •] ë£¨íŠ¸ì— ìˆëŠ” Dockerfile ì§€ì •
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/p_auth_service:${{ github.sha }}
          # [ì¶”ê°€] ê³µìš© Dockerfileì— "ì´ê±´ auth-service ë¹Œë“œì•¼"ë¼ê³  ì•Œë ¤ì¤Œ
          build-args: |
            SERVICE_NAME=auth-service

      # 6. Manifest Repo ì—…ë°ì´íŠ¸ (GitOps)
      - name: Update Manifest
        env:
          GIT_TOKEN: ${{ secrets.GH_PAT_TOKEN }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          git clone https://x-access-token:${GIT_TOKEN}@github.com/studylinker/manifest.git manifest-repo
          cd manifest-repo/apps/auth-service  # ğŸ‘ˆ êµ¬ì¡°ì— ë§ê²Œ ê²½ë¡œ ìˆ˜ì • í•„ìš”
          
          # deployment.yamlì˜ ì´ë¯¸ì§€ íƒœê·¸ ìˆ˜ì •
          sed -i "s|image: .*|image: ${DOCKER_USER}/auth-service:${{ github.sha }}|g" deployment.yaml
          
          git config user.name "CI Bot"
          git config user.email "ci@bot.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update auth-service image to ${{ github.sha }}"
            git push
          else
            echo "No changes to commit"
          fi
